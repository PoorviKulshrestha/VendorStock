<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VendorStock - Smart Inventory Manager</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .auth-card {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-secondary { background: #764ba2; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-success { background: #27ae60; color: white; }

    .btn-primary:hover:not(:disabled), .btn-secondary:hover:not(:disabled), 
    .btn-success:hover:not(:disabled), .btn-danger:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .dashboard-container {
      display: none;
      min-height: 100vh;
      display: flex;
    }

    .sidebar {
      width: 250px;
      background: #2c3e50;
      padding: 20px;
      color: white;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.2);
    }

    .sidebar-header {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #667eea;
    }

    .sidebar-header h2 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.7;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 30px;
    }

    .nav-item {
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(102, 126, 234, 0.1);
      color: white;
      border: none;
      font-size: 14px;
      font-weight: 600;
      text-align: left;
    }

    .nav-item:hover {
      background: rgba(102, 126, 234, 0.3);
    }

    .nav-item.active {
      background: #667eea;
    }

    .logout-btn {
      padding: 12px 15px;
      background: #e74c3c;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      margin-top: auto;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .header h2 {
      color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .product-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 15px;
    }

    .product-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .product-info {
      color: #666;
      font-size: 14px;
      margin: 5px 0;
    }

    .product-quantity {
      font-size: 24px;
      font-weight: bold;
      color: #27ae60;
      margin: 10px 0;
    }

    .low-stock { color: #e74c3c; }

    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-small {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }

    .form-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    table {
      width: 100%;
      background: white;
      border-radius: 15px;
      overflow: hidden;
      border-collapse: collapse;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    thead {
      background: #667eea;
      color: white;
    }

    th, td {
      padding: 15px;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: #f8f9fa;
    }

    .hidden { display: none !important; }

    .error-msg {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }

    .success-msg {
      color: #27ae60;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }

    /* Chat Styles */
    .chat-container {
      background: white;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      height: 600px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
    }

    .message.user .message-bubble {
      background: #667eea;
      color: white;
    }

    .message.ai .message-bubble {
      background: #f0f0f0;
      color: #333;
    }

    .chat-input-area {
      padding: 20px;
      display: flex;
      gap: 10px;
    }

    .chat-input-area input {
      margin: 0;
      flex: 1;
    }

    .chat-input-area button {
      width: auto;
      padding: 12px 20px;
      margin: 0;
    }

    /* Analytics Styles */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .analytics-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .analytics-card h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .analytics-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .analytics-item:last-child {
      border-bottom: none;
    }

    .analytics-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .analytics-bar-fill {
      height: 100%;
      background: #667eea;
    }

    @media (max-width: 768px) {
      .dashboard-container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        overflow-x: auto;
      }
      .sidebar-nav {
        flex-direction: row;
      }
      .products-grid { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .chat-container { height: 400px; }
      .message-bubble { max-width: 90%; }
    }
  </style>
</head>
<body>

  <div id="authScreen" class="auth-container">
    <div class="auth-card">
      <h1> VendorStock</h1>
      <p class="subtitle">Smart Inventory Management</p>
      
      <div id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button class="btn-primary" id="loginBtn">Login</button>
        <button class="btn-secondary" id="showSignupBtn">Create Account</button>
        <div id="loginMessage"></div>
      </div>

      <div id="signupForm" class="hidden">
        <input type="text" id="signupShopName" placeholder="Shop Name">
        <input type="email" id="signupEmail" placeholder="Email">
        <input type="tel" id="signupPhone" placeholder="Phone Number">
        <input type="password" id="signupPassword" placeholder="Password (min 6 chars)">
        <button class="btn-primary" id="signupBtn">Create Account</button>
        <button class="btn-secondary" id="showLoginBtn">Back to Login</button>
        <div id="signupMessage"></div>
      </div>
    </div>
  </div>

  <div id="dashboard" class="dashboard-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2> <span id="shopName">VendorStock</span></h2>
        <p id="userEmail"></p>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-tab="overview"> Overview</button>
        <button class="nav-item" data-tab="products"> Products</button>
        <button class="nav-item" data-tab="sales"> Sales</button>
        <button class="nav-item" data-tab="analytics"> Analytics</button>
        <button class="nav-item" data-tab="chat"> AI Chat</button>
      </nav>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="content">
      <!-- Overview Tab -->
      <div id="overviewTab" class="tab-content active">
        <div class="header">
          <h2> Overview</h2>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Products</div>
            <div class="stat-value" id="totalProducts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Low Stock</div>
            <div class="stat-value" id="lowStockCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Today's Sales</div>
            <div class="stat-value">‚Çπ<span id="todaySales">0</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Today's Profit</div>
            <div class="stat-value">‚Çπ<span id="todayProfit">0</span></div>
          </div>
        </div>
        <div id="alertsContainer"></div>
        <h3 style="margin: 20px 0; color: #333;">Recent Products</h3>
        <div id="recentProducts" class="products-grid"></div>
      </div>

      <!-- Products Tab -->
      <div id="productsTab" class="tab-content">
        <div class="header">
          <h2> Products</h2>
        </div>
        <div class="form-container">
          <h3 style="margin-bottom: 20px;">Add New Product</h3>
          <div class="form-grid">
            <div><label>Product Name</label><input type="text" id="productName"></div>
            <div>
              <label>Category</label>
              <select id="productCategory">
                <option>Grocery</option>
                <option>Beverages</option>
                <option>Snacks</option>
                <option>Personal Care</option>
                <option>Other</option>
              </select>
            </div>
            <div><label>Cost Price (‚Çπ)</label><input type="number" id="costPrice"></div>
            <div><label>Selling Price (‚Çπ)</label><input type="number" id="sellingPrice"></div>
            <div><label>Quantity</label><input type="number" id="quantity"></div>
            <div><label>Low Stock Alert</label><input type="number" id="lowStockThreshold"></div>
          </div>
          <button class="btn-success" id="addProductBtn" style="margin-top: 20px;">Add Product</button>
        </div>
        <h3 style="margin: 20px 0; color: #333;">All Products</h3>
        <div id="allProducts" class="products-grid"></div>
      </div>

      <!-- Sales Tab -->
      <div id="salesTab" class="tab-content">
        <div class="header">
          <h2> Sales</h2>
        </div>
        <div class="form-container">
          <h3 style="margin-bottom: 20px;">Record Sale</h3>
          <div class="form-grid">
            <div>
              <label>Select Product</label>
              <select id="saleProduct"><option value="">Choose...</option></select>
            </div>
            <div><label>Quantity Sold</label><input type="number" id="saleQuantity" min="1"></div>
          </div>
          <button class="btn-success" id="recordSaleBtn" style="margin-top: 20px;">Record Sale</button>
        </div>
        <h3 style="margin: 20px 0; color: #333;">Recent Sales</h3>
        <table>
          <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th><th>Profit</th></tr></thead>
          <tbody id="salesTableBody"><tr><td colspan="5" style="text-align:center;padding:30px;">No sales yet</td></tr></tbody>
        </table>
      </div>

      <!-- Analytics Tab -->
      <div id="analyticsTab" class="tab-content">
        <div class="header">
          <h2> Analytics & AI Insights</h2>
        </div>
        <div class="analytics-grid" id="analyticsContainer">
          <div class="analytics-card">
            <h3>Click to load analytics...</h3>
          </div>
        </div>
      </div>

      <!-- Chat Tab -->
      <div id="chatTab" class="tab-content">
        <div class="header">
          <h2> AI Assistant</h2>
        </div>
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ask me about inventory, sales, or recommendations...">
            <button class="btn-primary" id="sendChatBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: _API_KEY,
      authDomain: _AUTH_DOMAIN,
      projectId: _PROJECT_ID ,
      storageBucket: _STORAGE_BUCKET,
      messagingSenderId: _MESSAGING_SENDER_ID,
      appId: _APP_ID
    };

    const COHERE_API_KEY = _COHERE_KEY; // Add your Cohere API key here

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let productsData = [];

    const icons = { 'Grocery': 'üåæ', 'Beverages': 'ü•§', 'Snacks': 'üçø', 'Personal Care': 'üß¥', 'Other': 'üì¶' };

    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        document.getElementById('userEmail').textContent = user.email;
        loadUserData();
        loadProducts();
        loadSales();
      } else {
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('dashboard').style.display = 'none';
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('showSignupBtn').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('signupForm').classList.remove('hidden');
      });

      document.getElementById('showLoginBtn').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
      });

      // Tab navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const tabName = item.dataset.tab;
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          item.classList.add('active');
          document.getElementById(tabName + 'Tab').classList.add('active');
          
          // Load analytics when tab is clicked
          if (tabName === 'analytics') {
            setTimeout(() => generateAnalytics(), 100);
          }
          
          // Initialize chat when tab is clicked
          if (tabName === 'chat' && document.getElementById('chatMessages').children.length === 0) {
            addChatMessage('Hello! I\'m your AI inventory assistant. Ask me about your products, sales, or recommendations!', 'ai');
          }
        });
      });

      // Chat functionality
      document.getElementById('sendChatBtn').addEventListener('click', sendChat);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
      });
    });

    document.getElementById('signupBtn').addEventListener('click', async () => {
      const btn = document.getElementById('signupBtn');
      const msg = document.getElementById('signupMessage');
      const shopName = document.getElementById('signupShopName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const phone = document.getElementById('signupPhone').value.trim();
      const password = document.getElementById('signupPassword').value;

      msg.textContent = '';

      if (!shopName || !email || !phone || !password) {
        msg.textContent = 'Please fill all fields';
        msg.className = 'error-msg';
        return;
      }

      if (password.length < 6) {
        msg.textContent = 'Password must be at least 6 characters';
        msg.className = 'error-msg';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(cred.user.uid).set({
          shopName, email, phoneNumber: phone,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msg.textContent = ' Account created successfully!';
        msg.className = 'success-msg';
      } catch (e) {
        msg.textContent = '‚ùå ' + e.message;
        msg.className = 'error-msg';
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      const btn = document.getElementById('loginBtn');
      const msg = document.getElementById('loginMessage');
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      msg.textContent = '';

      if (!email || !password) {
        msg.textContent = 'Please enter credentials';
        msg.className = 'error-msg';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Logging in...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (e) {
        msg.textContent = '‚ùå ' + e.message;
        msg.className = 'error-msg';
        btn.disabled = false;
        btn.textContent = 'Login';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut();
    });

    async function loadUserData() {
      try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists) {
          document.getElementById('shopName').textContent = doc.data().shopName || 'My Shop';
        }
      } catch (e) { console.error(e); }
    }

    document.getElementById('addProductBtn').addEventListener('click', async () => {
      const name = document.getElementById('productName').value.trim();
      const category = document.getElementById('productCategory').value;
      const cost = parseFloat(document.getElementById('costPrice').value);
      const sell = parseFloat(document.getElementById('sellingPrice').value);
      const qty = parseInt(document.getElementById('quantity').value);
      const threshold = parseInt(document.getElementById('lowStockThreshold').value);

      if (!name || isNaN(cost) || isNaN(sell) || isNaN(qty) || isNaN(threshold)) {
        alert('Please fill all fields correctly');
        return;
      }

      try {
        await db.collection('products').add({
          userId: currentUser.uid, name, category, costPrice: cost, sellingPrice: sell,
          quantity: qty, lowStockThreshold: threshold,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('Product added successfully!');
        ['productName','costPrice','sellingPrice','quantity','lowStockThreshold']
          .forEach(id => document.getElementById(id).value = '');
      } catch (e) { 
        console.error('Add product error:', e);
        alert('Error: ' + e.message); 
      }
    });

    function loadProducts() {
      db.collection('products')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snap) => {
          productsData = [];
          let lowStock = 0;
          
          snap.forEach(doc => {
            const p = { id: doc.id, ...doc.data() };
            productsData.push(p);
            if (p.quantity <= p.lowStockThreshold) lowStock++;
          });

          productsData.sort((a, b) => {
            const aTime = a.createdAt ? a.createdAt.toMillis() : 0;
            const bTime = b.createdAt ? b.createdAt.toMillis() : 0;
            return bTime - aTime;
          });

          displayProducts();
          updateDropdown();
          displayAlerts();
          document.getElementById('totalProducts').textContent = productsData.length;
          document.getElementById('lowStockCount').textContent = lowStock;
        }, (error) => {
          console.error('Error loading products:', error);
        });
    }

    function displayProducts() {
      const html = productsData.map(p => {
        const low = p.quantity <= p.lowStockThreshold;
        return `<div class="product-card">
          <div class="product-icon">${icons[p.category] || 'üì¶'}</div>
          <div class="product-name">${p.name}</div>
          <div class="product-info">Category: ${p.category}</div>
          <div class="product-info">Cost: ‚Çπ${p.costPrice} | Sell: ‚Çπ${p.sellingPrice}</div>
          <div class="product-quantity ${low?'low-stock':''}">${p.quantity} units ${low?'‚ö†Ô∏è':''}</div>
          <div class="product-actions">
            <button class="btn-primary btn-small" onclick="updateStock('${p.id}',${p.quantity})">Update</button>
            <button class="btn-danger btn-small" onclick="deleteProduct('${p.id}')">Delete</button>
          </div>
        </div>`;
      }).join('');
      
      const fallback = '<p style="text-align:center;padding:20px;">No products yet. Go to Products tab to add one!</p>';
      document.getElementById('recentProducts').innerHTML = html || fallback;
      document.getElementById('allProducts').innerHTML = html || '<p style="text-align:center;padding:20px;">No products yet</p>';
    }

    async function updateStock(id, cur) {
      const n = prompt('Enter new quantity:', cur);
      if (n !== null && !isNaN(n)) {
        try {
          await db.collection('products').doc(id).update({ quantity: parseInt(n) });
          alert('Stock updated!');
        } catch (e) { alert('Error: ' + e.message); }
      }
    }

    async function deleteProduct(id) {
      if (confirm('Delete this product?')) {
        try {
          await db.collection('products').doc(id).delete();
          alert('Product deleted!');
        } catch (e) { alert('Error: ' + e.message); }
      }
    }

    function updateDropdown() {
      const sel = document.getElementById('saleProduct');
      sel.innerHTML = '<option value="">Choose...</option>';
      productsData.forEach(p => {
        sel.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.quantity})</option>`;
      });
    }

    async function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      if (!COHERE_API_KEY) {
        alert('‚ö†Ô∏è Please add your Cohere API key in the code first!');
        return;
      }

      addChatMessage(message, 'user');
      input.value = '';

      const context = generateContextData();
      
      try {
        const response = await fetch('https://api.cohere.com/v1/chat', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${COHERE_API_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: 'command-r-plus-08-2024',
            message: `Inventory Assistant - Store Context: ${context}. User asks: ${message}. Provide helpful advice based on their inventory.`
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Cohere API Error:', response.status, errorData);
          throw new Error(`API Error: ${errorData.message || response.status}`);
        }

        const data = await response.json();
        const aiResponse = data.text.trim();
        addChatMessage(aiResponse, 'ai');
      } catch (error) {
        console.error('Cohere API Error:', error);
        addChatMessage('Error: ' + error.message, 'ai');
      }
    }

    function addChatMessage(text, sender) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageEl = document.createElement('div');
      messageEl.className = `message ${sender}`;
      messageEl.innerHTML = `<div class="message-bubble">${text}</div>`;
      messagesDiv.appendChild(messageEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function generateContextData() {
      const totalProducts = productsData.length;
      const lowStockItems = productsData.filter(p => p.quantity <= p.lowStockThreshold).length;
      const totalValue = productsData.reduce((sum, p) => sum + (p.quantity * p.costPrice), 0);
      const avgMargin = productsData.length > 0 
        ? ((productsData.reduce((sum, p) => sum + (p.sellingPrice - p.costPrice), 0) / productsData.length) * 100).toFixed(1)
        : 0;

      return `Total Products: ${totalProducts}
Low Stock Items: ${lowStockItems}
Total Inventory Value: ‚Çπ${totalValue.toFixed(2)}
Average Profit Margin: ${avgMargin}%
Products by Category: ${Object.entries(productsData.reduce((acc, p) => {
        acc[p.category] = (acc[p.category] || 0) + 1;
        return acc;
      }, {})).map(([k, v]) => `${k}: ${v}`).join(', ')}`;
    }

    async function generateAnalytics() {
      const container = document.getElementById('analyticsContainer');
      
      if (!COHERE_API_KEY) {
        container.innerHTML = '<div class="analytics-card"><h3>‚ö†Ô∏è API Key Missing</h3><p>Please add your Cohere API key to enable AI analytics.</p></div>';
        return;
      }

      // Show loading state
      container.innerHTML = '<div class="analytics-card"><h3>‚è≥ Loading AI insights...</h3><p>Analyzing your inventory data...</p></div>';

      const context = generateContextData();

      try {
        const response = await fetch('https://api.cohere.com/v1/chat', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${COHERE_API_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: 'command-r-plus-08-2024',
            message: `Store inventory data: ${context}. Provide 3 key recommendations in this exact JSON format: [{"title":"Recommendation 1","description":"Details"}]`
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Analytics Error:', response.status, errorData);
          throw new Error('API Error: ' + (errorData.message || response.status));
        }
        
        const data = await response.json();
        const responseText = data.text.trim();
        
        const jsonMatch = responseText.match(/\[[\s\S]*\]/);
        const recommendations = jsonMatch ? JSON.parse(jsonMatch[0]) : [];

        displayAnalyticsInsights(recommendations);
      } catch (error) {
        console.error('Analytics Error:', error);
        // Show fallback analytics if API fails
        displayAnalyticsInsights([
          { title: 'Inventory Overview', description: `You have ${productsData.length} products with ${productsData.filter(p => p.quantity <= p.lowStockThreshold).length} low stock items.` },
          { title: 'Top Categories', description: Object.keys(productsData.reduce((acc, p) => {
            acc[p.category] = (acc[p.category] || 0) + 1;
            return acc;
          }, {})).join(', ') || 'No products yet' },
          { title: 'Note', description: 'Some AI features temporarily unavailable. Basic analytics shown above.' }
        ]);
      }
    }

    function displayAnalyticsInsights(insights) {
      let html = '';
      
      const lowStock = productsData.filter(p => p.quantity <= p.lowStockThreshold);
      const topProduct = productsData.reduce((max, p) => 
        (p.quantity * p.sellingPrice > (max.quantity * max.sellingPrice) ? p : max), {quantity: 0, name: 'N/A', sellingPrice: 0});

      html += `<div class="analytics-card">
        <h3>üìä Key Metrics</h3>
        <div class="analytics-item">
          <span>Total Products</span>
          <strong>${productsData.length}</strong>
        </div>
        <div class="analytics-item">
          <span>Low Stock Alert</span>
          <strong style="color: #e74c3c;">${lowStock.length}</strong>
        </div>
        <div class="analytics-item">
          <span>Top Product Value</span>
          <strong>‚Çπ${(topProduct.quantity * topProduct.sellingPrice).toFixed(0)}</strong>
        </div>
      </div>`;

      const categories = productsData.reduce((acc, p) => {
        acc[p.category] = (acc[p.category] || 0) + 1;
        return acc;
      }, {});
      const maxCat = Math.max(...Object.values(categories), 1);

      html += `<div class="analytics-card">
        <h3>üìÅ By Category</h3>
        ${Object.entries(categories).map(([cat, count]) => `
          <div class="analytics-item">
            <span>${cat}</span>
            <strong>${count}</strong>
            <div class="analytics-bar">
              <div class="analytics-bar-fill" style="width: ${(count/maxCat)*100}%"></div>
            </div>
          </div>
        `).join('')}
      </div>`;

      if (insights.length > 0) {
        html += `<div class="analytics-card">
          <h3>ü§ñ AI Recommendations</h3>
          ${insights.map(r => `
            <div class="analytics-item">
              <div>
                <strong>${r.title}</strong>
                <p style="font-size: 12px; color: #666; margin-top: 4px;">${r.description}</p>
              </div>
            </div>
          `).join('')}
        </div>`;
      }

      document.getElementById('analyticsContainer').innerHTML = html;
    }

    document.getElementById('recordSaleBtn').addEventListener('click', async () => {
      const pid = document.getElementById('saleProduct').value;
      const qty = parseInt(document.getElementById('saleQuantity').value);
      if (!pid || !qty) {
        alert('‚ùå Select product and quantity');
        return;
      }
      const p = productsData.find(x => x.id === pid);
      if (qty > p.quantity) {
        alert('‚ùå Insufficient stock! Available: ' + p.quantity);
        return;
      }

      try {
        const amt = p.sellingPrice * qty;
        const profit = (p.sellingPrice - p.costPrice) * qty;
        await db.collection('sales').add({
          userId: currentUser.uid, productId: pid, productName: p.name,
          quantitySold: qty, salePrice: p.sellingPrice, totalAmount: amt, profit,
          saleDate: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('products').doc(pid).update({ quantity: p.quantity - qty });
        alert('‚úÖ Sale recorded!');
        document.getElementById('saleQuantity').value = '';
        document.getElementById('saleProduct').value = '';
        loadSales();
      } catch (e) { alert('‚ùå Error: ' + e.message); }
    });

    function loadSales() {
      const today = new Date(); 
      today.setHours(0,0,0,0);
      
      db.collection('sales')
        .where('userId', '==', currentUser.uid)
        .limit(50)
        .onSnapshot(snap => {
          let sales = 0, profit = 0;
          const tbody = document.getElementById('salesTableBody');
          tbody.innerHTML = '';
          
          const salesArray = [];
          snap.forEach(doc => {
            salesArray.push({ id: doc.id, ...doc.data() });
          });
          
          salesArray.sort((a, b) => {
            const aTime = a.saleDate ? a.saleDate.toMillis() : 0;
            const bTime = b.saleDate ? b.saleDate.toMillis() : 0;
            return bTime - aTime;
          });
          
          salesArray.slice(0, 20).forEach(s => {
            const d = s.saleDate ? s.saleDate.toDate() : new Date();
            if (d >= today) { 
              sales += s.totalAmount; 
              profit += s.profit; 
            }
            tbody.innerHTML += `<tr>
              <td>${d.toLocaleDateString()} ${d.toLocaleTimeString()}</td>
              <td>${s.productName}</td><td>${s.quantitySold}</td>
              <td>‚Çπ${s.totalAmount}</td><td>‚Çπ${s.profit}</td>
            </tr>`;
          });
          
          if (salesArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;">No sales yet</td></tr>';
          }
          
          document.getElementById('todaySales').textContent = sales;
          document.getElementById('todayProfit').textContent = profit;
        });
    }

    function displayAlerts() {
      const low = productsData.filter(p => p.quantity <= p.lowStockThreshold);
      const c = document.getElementById('alertsContainer');
      if (low.length) {
        c.innerHTML = low.map(p => 
          `<div class="alert">‚ö†Ô∏è Low stock: ${p.name} (${p.quantity} units left)</div>`
        ).join('');
      } else {
        c.innerHTML = '';
      }
    }

    console.log('‚úÖ VendorStock with Cohere AI initialized successfully!');
  </script>
</body>
</html>